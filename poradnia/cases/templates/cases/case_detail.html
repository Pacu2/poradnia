{% extends 'cases/base.html' %}
{% load guardian_tags crispy_forms_tags staticfiles humanize i18n cases_tags %}
{%block title%}{{object}} - {{block.super}}{%endblock%}
{% block javascript %}
{{block.super}}
<script type="text/javascript" src="{% static 'js/jquery.formset.js' %}"></script>
<script type="text/javascript">
  $(function() {
    $('form tbody tr').formset({addText:"{% trans 'add another'%}", deleteText: "{% trans 'remove'%}"});
  });
  $('#form-tab a').click(function (e) {
    e.preventDefault()
    $(this).tab('show')
  });
  $('#form-tab a:last').tab('show')
</script>
{% endblock %}
{% block breadcrumbs%}
<ol class="breadcrumb">
  <li><a href="{% url 'cases:list'%}">{% trans 'Cases'%}</a></li>
  <li class="active">{{object}}</li>
</ol>
{% endblock %}

{%block content%}
{% get_obj_perms request.user for object as "case_perms" %}
<div class="row">
  <div class="col-xs-12">
    <div class="case-header">
      <div class="case-header-actions">
        {% if 'change_case' in case_perms %}
        <a class="btn btn-primary" href="{{ object.get_edit_url }}"><span class="glyphicon glyphicon-edit"></span> {% trans 'Edit'%}</a>
        {% endif %}
        {% if 'can_assign' in case_perms %}
        <a class="btn btn-primary" href="{% url 'cases:permission_add' pk=object.pk %}"><span class="glyphicon glyphicon-eye-close"></span> {% trans 'Add permissions' %}</a>
        <a class="btn btn-primary" href="{% url 'cases:permission_update' pk=object.pk %}"><span class="glyphicon glyphicon-eye-close"></span> {% trans 'Update permissions' %}</a>
        {% endif %}
      </div>
      <h1 class="case-header-title">{{object.name}} <span class="case-header-number">#{{object.pk}}</span></h1>
      <div class="case-header-meta">
        {% if object.status_changed %}
          <span class="label label-success" title="Ostatnia zmiana stanu: {{ object.status_changed }} dni temu"> <i class="{{object.status|status2css}}"></i> {{object.status_display}}</span> 
        {% else %}
          <span class="label label-success" title="Ostatnia zmiana 7 dni temu"> <i class="fa fa-folder-open-o"></i> {{ object.status }}</span> 
        {%endif%}
        Utworzona przez <a href="{{object.created_by.get_absolute_url}}">{{object.created_by}}</a> 
        {{object.created_on|naturaltime}} dla 
        <a href="{{object.client.get_absolute_url}}">{{object.client}}</a> 
      </div>
    </div>
  </div>
</div>


<div class="row">
  <div class="col-lg-6">
    <div class="panel panel-default">
      <div class="panel-heading"><span class="glyphicon glyphicon-transfer"></span> {% trans 'Workflow'%}</div>
      <table class="table">
        <tr>
          <td><span class="glyphicon glyphicon-user"></span> {% trans 'Involved in' %}</td>
          <td>{% for user in object.get_users_with_perms.all %}<a class="label label-info" href="{{user.get_absolute_url}}">{{user}}</a>{% endfor%}</td>
        </tr>
        {% if object.modified_by %}
        <tr>
          <td>{% trans 'Last update'%}</td>
          <td>
            <a href="{{object.modified_by.get_absolute_url}}">{{object.modified_by}}</a> on {{object.modified_on}}
          </td>
        </tr>
        {% endif %}
        {% if object.deadline %}
        <tr>
          <td><span class="glyphicon glyphicon-fire"></span> {% trans 'Dead-line'%}</td>
          <td>{% blocktrans with object.deadline as deadline and object.deadline.time|naturaltime as naturaltime %}{{deadline}} at {{naturaltime}}{% endblocktrans %}</td>
        </tr>
        {%endif%}
      </table>
    </div> 
  </div>

  {% if request.user.is_staff %}
  <div class=" col-lg-6">
    <div class="panel panel-default">
      <div class="panel-heading"><span class="glyphicon glyphicon-earphone"></span> {% trans 'Metrical data'%}</div>
      <table class="table">
        <tr>
          <td><i class="glyphicon glyphicon-stats"></i> {% trans 'Advice' %}</a></td>
          <td>
            {% if object.advice %}
            <a href="{{object.advice.get_absolute_url}}">{{object.advice}}</a>
            {% else %}
            <a href="{% url 'registers:create'%}?case={{object.pk}}"><i class="glyphicon glyphicon-pencil"></i> {% trans 'Create new advice'%}</a>
            {% endif %}
          </td>
        </tr>
      </table>
    </div>
  </div>
  {% endif %}
</div>
<div class="row"><div class="col-xs-12"><h2>{% trans 'Record'%}</h2></div></div>
  {% if record_list %}
<div class="timeline">
  {% for record in record_list %}
  {% include record.content_object.get_template_list with object=record.content_object %}
  {% endfor %}
</div>
  {% else %}
  <span class="label label-warning">{% trans 'No records'%}</span>
  {% endif %}
{% if 'can_add_record' in case_perms %}
<div role="tabpanel" class="row">

  <ul class="nav nav-tabs" role="tablist" id="form-tab">
    {% for label, row in forms.items %}
    <li role="presentation"><a href="#{{label}}" aria-controls="{{label}}" role="tab" data-toggle="tab">{{row.title}}</a></li>
    {% endfor %}
  </ul>

  <div class="tab-content">
    {% for key, row in forms.items %}
    <div role="tabpanel" class="tab-pane" id="{{key}}">
      <h2>{{row.title}}</h2>
      <form method="post" enctype="multipart/form-data" action="{{row.form.helper.form_action}}">
        {% crispy row.form %}
        {% if row.formset %}
        {% crispy row.formset %}
        {% endif %}
        <div class="form-actions">  
          <button type="submit" class="btn btn-primary">{% trans 'Save changes'%}</button>  
          <button class="btn">{% trans 'Cancel'%}</button>  
        </div>
      </form>  
    </div>
    {% endfor %}
  </div>
</div>
{% endif %}
{%endblock%}
